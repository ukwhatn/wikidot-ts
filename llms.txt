# @ukwhatn/wikidot

> An async utility library for interacting with Wikidot sites in TypeScript

## Overview

@ukwhatn/wikidot is a TypeScript library for working with the Wikidot API. It supports major Wikidot features including page retrieval and editing, forum operations, private messages, and user information retrieval.

## Important: Result Type

This library uses the Result type from neverthrow. All async methods return `WikidotResultAsync<T>`.

```typescript
// Correct usage
const clientResult = await Client.create();
if (!clientResult.isOk()) {
  throw new Error('Failed');
}
const client = clientResult.value;  // Client type is obtained here
```

## Main Components

### Client

Main entry point. Provides authentication and accessor access.

```typescript
import { Client } from '@ukwhatn/wikidot';

// Unauthenticated client
const clientResult = await Client.create();
const client = clientResult.value;

// Authenticated client
const authResult = await Client.create({ username, password });
const authClient = authResult.value;

client.site            // SiteAccessor
client.user            // UserAccessor
client.privateMessage  // PrivateMessageAccessor
```

### Site

Site operations. Access to pages, forums, and members.

```typescript
const siteResult = await client.site.get('scp-jp');
const site = siteResult.value;

site.page   // PageAccessor
site.pages  // PagesAccessor
site.forum  // ForumAccessor
site.member // MemberAccessor
```

### Page

Page operations. Edit, delete, vote, files, and revisions.

```typescript
const pageResult = await site.page.get('scp-001');
const page = pageResult.value;

page.title      // Page title
page.rating     // Rating
page.tags       // Tags array
page.createdBy  // Creator
page.createdAt  // Creation date

await page.edit({ source: 'new content' });
await page.vote(1);
await page.getFiles();
await page.getMetas();
```

### SearchPagesQuery

Query expression for ListPagesModule.

```typescript
const query = new SearchPagesQuery({
  category: 'scp',
  tags: ['+safe', '-euclid'],
  rating: '>10',
  order: 'rating desc',
  limit: 100,
});

const pagesResult = await site.pages.search(query);
```

### ForumThread / ForumPost

Forum operations. Thread replies, post editing and deletion.

```typescript
const threadResult = await site.forum.getThread(12345);
const thread = threadResult.value;

await thread.reply('Reply content', 'Title');
await thread.rename('New title');

const postsResult = await thread.getPosts();
const post = postsResult.value[0];
await post.edit('New content');
await post.delete();
```

### PrivateMessage

Private message operations. Inbox, sent box, and search.

```typescript
const inboxResult = await client.privateMessage.inbox();
const sentResult = await client.privateMessage.sentBox();
const searchResult = await client.privateMessage.search('query', 'all');

await client.privateMessage.send(user, 'Subject', 'Body');
```

## Result Type

All async operations return `WikidotResultAsync<T>` (neverthrow-based).

```typescript
const result = await site.page.get('page-name');

if (result.isOk()) {
  const page = result.value;
} else {
  const error = result.error;  // WikidotError
}
```

## Error Hierarchy

```
WikidotError
├── UnexpectedError
├── LoginRequiredError
├── AMCError
│   ├── AMCHttpError
│   ├── WikidotStatusError
│   └── ResponseDataError
├── NotFoundException
├── TargetExistsError
├── TargetError
├── ForbiddenError
└── NoElementError
```

## User Hierarchy

```
AbstractUser
├── User           # Regular user
├── DeletedUser    # Deleted user
├── AnonymousUser  # Anonymous (with IP)
├── GuestUser      # Guest
└── WikidotUser    # System user
```

## Directory Structure

```
src/
├── common/           # Common utilities
│   ├── errors/       # Error definitions
│   └── types.ts      # Result type definitions
├── connector/        # HTTP communication
│   ├── amc-client.ts # AjaxModuleConnector
│   └── amc-config.ts # Configuration
├── module/           # Core modules
│   ├── client/       # Client
│   ├── site/         # Site
│   ├── page/         # Page, PageRevision, PageFile, etc.
│   ├── forum/        # ForumCategory, ForumThread, ForumPost
│   ├── private-message/ # PrivateMessage
│   ├── user/         # User hierarchy
│   └── types.ts      # Shared interfaces
└── util/             # Utilities
    ├── parser/       # HTML parser
    └── quick-module.ts # QuickModule API
```

## Main Methods List

### Client
- `site.get(unixName)` - Get site
- `user.get(username)` - Get user
- `privateMessage.inbox()` - Get inbox
- `privateMessage.sentBox()` - Get sent box
- `privateMessage.send(user, subject, body)` - Send message
- `privateMessage.search(query, searchType)` - Search messages

### Site
- `page.get(fullname)` - Get page
- `pages.search(query)` - Search pages
- `pages.all()` - Get all pages
- `pages.getRecentChanges()` - Get recent changes
- `forum.getCategories()` - Get category list
- `forum.getThread(id)` - Get thread
- `member.getAll()` - Get member list
- `member.lookup(query)` - Search members

### Page
- `edit(options)` - Edit page
- `destroy()` - Delete page
- `rename(newFullname)` - Rename page
- `vote(value)` - Vote
- `cancelVote()` - Cancel vote
- `commitTags()` - Save tags
- `setParent(fullname)` - Set parent page
- `getFiles()` - Get file list
- `getMetas()` - Get meta tags
- `setMeta(name, content)` - Set meta tag
- `deleteMeta(name)` - Delete meta tag

### ForumThread
- `getPosts()` - Get post list
- `reply(source, title)` - Reply
- `rename(newTitle)` - Change title

### ForumPost
- `getSource()` - Get source
- `edit(source, title)` - Edit
- `delete()` - Delete
